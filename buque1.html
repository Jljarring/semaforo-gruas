<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subir y Procesar Archivo Excel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.3/css/buttons.dataTables.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        body { font-family: Arial, sans-serif; background-color: #white; margin: 0; padding: 0; }
        .navbar { background-color: #343a40; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
        .navbar a { color: white; text-decoration: none; }
        .dropdown { position: relative; display: inline-block; }
        .dropdown-button { background-color: #6c757d; color: white; padding: 8px 12px; border: none; cursor: pointer; }
        .dropdown-content { display: none; position: absolute; background-color: #f9f9f9; min-width: 160px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 1; }
        .dropdown-content a { color: black; padding: 12px 16px; text-decoration: none; display: block; }
        .dropdown-content a:hover { background-color: #ddd; }
        .dropdown:hover .dropdown-content { display: block; }

#summaryModal {
    display: none;
    position: fixed;
    z-index: 1;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%); /* Asegura el centrado */
    width: 80%;
    max-width: 600px;
    height: auto;
    max-height: 80%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.4);
}
.modal-content {
    background-color: #fefefe;
    padding: 20px;
    border: 1px solid #888;
    width: 100%;
    box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover,
.close:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
}
      /* Estilos para las nuevas tablas */
.summary-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}

.summary-table th, .summary-table td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
}
      
          .container {
        width: 100%; /* Ajusta el ancho del contenedor según sea necesario */
        margin: 0 auto; /* Centra el contenedor */
    }
        .card { 
            background-color: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); 
            width: 50%;
            margin: 20px auto;
        }
        .card h2 { text-align: center; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; }
        .form-group input[type="file"] { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .form-group button { background-color: #28a745; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; }
        .form-group button:hover { background-color: #218838; }
        .form-buttons { text-align: center; margin-top: 20px; }
        .form-buttons button { margin: 0 10px; }


      #resultTable {
    width: 100%; /* O un valor fijo como 1200px */
    border-collapse: collapse;
    margin-top: 20px;
}
        #resultTable th { 
            background-color: navy;
            color: white;
            text-align: center;
            padding: 8px;
            border: 1px solid #ddd; 
        }
        #resultTable td { 
            padding: 8px; 
            border: 1px solid #ddd; 
            text-align: left;
       
        }

        /* Estilos para los colores de las grúas */
        #resultTable tbody tr.grua-1 { background-color: #FFD700; }
        #resultTable tbody tr.grua-2 { background-color: #ADD8E6; }
        #resultTable tbody tr.grua-3 { background-color: #90EE90; }
        #resultTable tbody tr.grua-4 { background-color: #FFA07A; }
        #resultTable tbody tr.grua-5 { background-color: #DDA0DD; }

        .container-grid { display: grid; }
        .container-cell { border: 1px solid #ddd; padding: 5px; text-align: center; }
          
button {
  padding: 10px 20px;
  border: none;
  border-radius: 5px;
  color: white;
  font-size: 16px;
  cursor: pointer;
}

button i {
  margin-right: 5px;
}

.btn-danger {
  background-color: red;
}

.btn-primary {
  background-color: blue;
}
    </style>
</head>
<body>
        <div id="summaryModal" class="modal" style="display: none; position: fixed; z-index: 1; left: 50%; top: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 800px; height: 90%; max-height: 90%; overflow: auto; background-color: rgba(0, 0, 0, 0.4);">
            <div class="modal-content" style="background-color: #fefefe; padding: 20px; border: 1px solid #888; width: 100%; box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);">
                <span class="close" style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
                <div id="modalSummaryContent"></div>
            </div>
        </div>
  
    <nav class="navbar">
        <a href="#">Desarrollo Independiente JJLG</a>
        <div class="dropdown">
            <button class="dropdown-button"><i class="fas fa-user"></i> invitado</button>
            <div class="dropdown-content">
                <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Cerrar sesión</a>
                <a href="#" id="btnAyuda"><i class="fas fa-question-circle"></i> Ayuda</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="card">
            <h2>Descarga de Contenedores en Buque</h2>
            <div class="form-group">
                <label for="fileBase">Cargar archivo Buque (Excel)</label>
                <input type="file" id="fileBase" accept=".xlsx, .xls">
                <button onclick="processBaseFile()">Procesar Base</button>
            </div>
            <div class="form-group">
                <label for="filePendientes">Cargar archivo Pendiente (Excel)</label>
                <input type="file" id="filePendientes" accept=".xlsx, .xls">
                <button onclick="processPendientesFile()">Procesar Pendientes</button>
            </div>
            <div class="form-buttons">
                     <button class="btn btn-danger" onclick="limpiarDatos()">
    <i class="fas fa-trash-alt"></i> Limpiar
  </button>
  <button class="btn btn-primary" onclick="showSummary()">
    <i class="fas fa-chart-bar"></i> Resumen descarga
  </button>
            </div>
        </div>
    </div>

    <div class="container">
        <table id="resultTable">
            <thead>
                <tr>
                    <th>Rango de Bahía</th>
                    <th>Total</th>
                    <th>Vacios</th>
                    <th>IMO</th>
                    <th>FULL</th>
                    <th>Conexión</th>
                    <th>Trasbordos</th>
                    <th>Sobredimensionados</th>
                    <th>Aperturas</th>
                    <th>Grúa</th>
                    <th>Vista Barco</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0/jquery.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.3/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.3/js/buttons.html5.min.js"></script>

    <script>
        const coloresGrúas = ['#FFD700', '#ADD8E6', '#90EE90', '#FFA07A', '#DDA0DD'];
        let jsonData = [];
        let jsonDataPendientes = [];
        let totalInicialGlobal = 0;

        function processBaseFile() {
            const fileInput = document.getElementById('fileBase');
            const file = fileInput.files[0];
            if (!file) { alert('Por favor selecciona un archivo Excel (Base).'); return; }
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const data = event.target.result;
                    const workbook = XLSX.read(data, { type: 'binary' });
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    jsonData = XLSX.utils.sheet_to_json(sheet);
                    totalInicialGlobal = jsonData.length;
                    const result = processDataVBA(jsonData);
                    displayResultsVBA(result);
                } catch (error) { alert('Error al procesar el archivo: ' + error.message); console.error(error); }
            };
            reader.readAsBinaryString(file);
        }

 
      function processPendientesFile() {
    const fileInput = document.getElementById('filePendientes');
    const file = fileInput.files[0];
    if (!file) {
        alert('Por favor selecciona un archivo Excel (Pendientes).');
        return;
    }
    const reader = new FileReader();
    reader.onload = function(event) {
        try {
            const data = event.target.result;
            const workbook = XLSX.read(data, { type: 'binary' });
            const sheetName = workbook.SheetNames[0];
            const sheet = workbook.Sheets[sheetName];
            const datos = XLSX.utils.sheet_to_json(sheet, { header: 1 });

            const encabezados = datos[0];
            const indiceCodSigla = encabezados.indexOf('cod_sigla');
            const indiceCodNumero = encabezados.indexOf('cod_numero');
            const indiceCodDigito = encabezados.indexOf('cod_digito');
            const indiceFecDescarga = encabezados.indexOf('fec_descarga');
            const indiceDesGrua = encabezados.indexOf('des_grua');
            const indiceCodBaroti = encabezados.indexOf('cod_baroti'); // Índice de la columna cod_baroti

            if (indiceCodSigla === -1 || indiceCodNumero === -1 || indiceCodDigito === -1 || indiceFecDescarga === -1 || indiceDesGrua === -1 || indiceCodBaroti === -1) {
                alert("Las columnas necesarias no están presentes en el archivo.");
                return;
            }

            const nuevaColumna = [];
            const estadoColumna = [];
            const gruaColumna = [];
            const bahiaColumna = []; // Nueva columna para almacenar las bahías

            for (let i = 1; i < datos.length; i++) {
                const fila = datos[i];
                const cod_sigla = fila[indiceCodSigla];
                const cod_numero = fila[indiceCodNumero];
                const cod_digito = fila[indiceCodDigito];
                const fec_descarga = fila[indiceFecDescarga];
                const des_grua = fila[indiceDesGrua];
                const codBaroti = fila[indiceCodBaroti];
                const bahia = parseInt(codBaroti.substring(0, 3)); // Obtener los primeros 3 caracteres y convertir a entero

                if (isNaN(bahia)) { // Validar si la bahía es un número válido
                    alert(`El valor de la bahía en la fila ${i + 1} no es válido.`);
                    return;
                }

                const cod_numero_completo = String(cod_numero).padStart(6, '0');
                const concatenado = cod_sigla + cod_numero_completo + cod_digito;
                nuevaColumna.push(concatenado);
                const estado = fec_descarga ? 'SI' : '';
                estadoColumna.push(estado);
                gruaColumna.push(des_grua);
                bahiaColumna.push(bahia); // Almacenar la bahía
            }

            jsonDataPendientes = XLSX.utils.sheet_to_json(sheet);
            jsonDataPendientes.forEach((fila, index) => {
                fila.CONCATENADO = nuevaColumna[index];
                fila.Estado = estadoColumna[index];
                fila.GRUA = gruaColumna[index];
                fila.BA = bahiaColumna[index]; // Agregar la bahía al objeto de datos
            });

            updateDataWithPendientes();
        } catch (error) {
            console.error('Error al procesar el archivo:', error);
            alert('Error al procesar el archivo: ' + error.message);
        }
    };
    reader.readAsBinaryString(file);
}

function updateDataWithPendientes() {
    try {
        const contenedoresPendientes = jsonDataPendientes
            .filter(fila => fila.Estado && fila.Estado.trim().toUpperCase() === 'SI')
            .map(fila => ({ contenedor: fila.CONCATENADO, grua: fila.GRUA, fecha: new Date(fila.fec_descarga), bahia: fila.BA }));

        jsonData = jsonData.filter(fila => {
            const contenedor = fila.CONTAINER;
            return !contenedoresPendientes.some(pend => pend.contenedor === contenedor);
        });

        const result = processDataVBA(jsonData);
        displayResultsVBA(result);

        // Almacenar la última ubicación de cada grúa
        let ultimaUbicacionGrúas = {};
        contenedoresPendientes.forEach(pendiente => {
            let grua = pendiente.grua.replace('GANTRY', 'Grúa '); // Convertir GANTRYX a Grúa X
            if (!ultimaUbicacionGrúas[grua] || pendiente.fecha > ultimaUbicacionGrúas[grua].fecha) {
                ultimaUbicacionGrúas[grua] = { fecha: pendiente.fecha, contenedor: pendiente.contenedor, bahia: pendiente.bahia };
            }
        });

        // Colorear filas según la última ubicación de la grúa y mostrar el nombre de la grúa
        const filasTabla = document.getElementById('resultTable').getElementsByTagName('tbody')[0].getElementsByTagName('tr');
        Array.from(filasTabla).forEach(fila => {
            const rangoBahia = fila.cells[0].textContent;
            const [inicioBahia, finBahia] = rangoBahia.split('-').map(Number);

            let gruaAsignada = ''; // Variable para almacenar el nombre de la grúa asignada

            for (const grua in ultimaUbicacionGrúas) {
                const ultimaBahia = ultimaUbicacionGrúas[grua].bahia;
                if (ultimaBahia >= inicioBahia && ultimaBahia <= finBahia) {
                    const indiceGrua = parseInt(grua.replace('Grúa ', '')) - 1;
                    if (!isNaN(indiceGrua) && indiceGrua >= 0 && indiceGrua < coloresGrúas.length) {
                        fila.style.backgroundColor = coloresGrúas[indiceGrua];
                        fila.dataset.grua = grua;
                        gruaAsignada = grua; // Almacenar el nombre de la grúa
                    }
                }
            }

            // Mostrar el nombre de la grúa en la celda correspondiente
            fila.cells[9].textContent = gruaAsignada;
        });

        // Mostrar la última ubicación de cada grúa
        console.log("Última ubicación de grúas:", ultimaUbicacionGrúas);
    } catch (error) {
        console.error('Error al actualizar los datos:', error);
        alert('Error al actualizar los datos: ' + error.message);
    }
}
           
          function processDataVBA(data) {
            let result = [];
            let maxBahia = Math.max(...data.map(row => parseInt(row["BA"])));
            let startRange = 1;

            let totalTotal = 0;
            let totalVacios = {};
            let totalImo = {};
            let totalFull = {};
            let totalConexion = {};
            let totalTransbordos = {};
            let totalSobredimensionados = {};
            let totalAperturas = {};

            while (startRange <= maxBahia) {
                let endRange = startRange + 2;
                if (endRange > maxBahia) endRange = maxBahia;
                const rangeLabel = `${startRange}-${endRange}`;

                let rangeData = {
                    range: rangeLabel,
                    total: 0,
                    vacios: {},
                    imo: {},
                    full: {},
                    conexion: {},
                    transbordos: {},
                    sobredimensionados: {},
                    aperturas: {}
                };

                data.forEach(item => {
                    const bahia = parseInt(item["BA"]);
                    const stat = item["STAT"];
                    const tipo = item["TYPE"];
                    const oper = item["OPER"];
                    const imo = item["IMO"];
                    const temp = item["TEMP"];
                    const transbordo = item["CONNECTING VESSEL"];
                    const fpod = item["FPOD"];
                    const sobredimensionado = item["DIMENSION"];

                    if (bahia >= startRange && bahia <= endRange) {
                        rangeData.total++;

                        if (item["STAT"] && (item["STAT"].trim() === "E" || item["STAT"].trim() === "M")) {
                            if (oper) rangeData.vacios[oper] = (rangeData.vacios[oper] || 0) + 1;
                            totalVacios[oper] = (totalVacios[oper] || 0) + 1;
                        }
                        if (imo && imo !== "-") {
                            rangeData.imo[tipo] = (rangeData.imo[tipo] || 0) + 1;
                            totalImo[tipo] = (totalImo[tipo] || 0) + 1;
                        }

                        if (temp && temp !== "-" && (!transbordo || transbordo === "-")) {
                            rangeData.conexion[tipo] = (rangeData.conexion[tipo] || 0) + 1;
                            totalConexion[tipo] = (totalConexion[tipo] || 0) + 1;
                        }

                        if (transbordo && transbordo !== "-") {
                            const transbordoKey = `${tipo}(${fpod})`;
                            rangeData.transbordos[transbordoKey] = (rangeData.transbordos[transbordoKey] || 0) + 1;
                            totalTransbordos[transbordoKey] = (totalTransbordos[transbordoKey] || 0) + 1;
                        }

                        if (sobredimensionado && sobredimensionado.trim().length > 0 && sobredimensionado !== "-") {
                            rangeData.sobredimensionados[tipo] = (rangeData.sobredimensionados[tipo] || 0) + 1;
                            totalSobredimensionados[tipo] = (totalSobredimensionados[tipo] || 0) + 1;
                        }

                        if (stat === "F" && (!transbordo || transbordo === "-") && (!imo || imo === "-") && (!temp || temp === "-") && (!sobredimensionado || sobredimensionado === "-")) {
                            rangeData.full[tipo] = (rangeData.full[tipo] || 0) + 1;
                            totalFull[tipo] = (totalFull[tipo] || 0) + 1;
                        }

                        if (stat === "L") {
                            rangeData.aperturas[tipo] = (rangeData.aperturas[tipo] || 0) + 1;
                            totalAperturas[tipo] = (totalAperturas[tipo] || 0) + 1;
                        }
                    }
                });
                totalTotal += rangeData.total;

                result.push(rangeData);
                startRange = endRange + 2;
            }

            result.push({
                range: "TOTAL",
                total: totalTotal,
                vacios: totalVacios,
                imo: totalImo,
                full: totalFull,
                conexion: totalConexion,
                transbordos: totalTransbordos,
                sobredimensionados: totalSobredimensionados,
                aperturas: totalAperturas
            });
            return result;
        }

        function displayResultsVBA(results) {
            const tbody = document.getElementById('resultTable').getElementsByTagName('tbody')[0];
            tbody.innerHTML = "";

            results.forEach(row => {
                let tr = document.createElement('tr');

                tr.addEventListener('click', (event) => selectRow(tr, event));
                tr.addEventListener('dblclick', () => {
                    deselectRow(tr);
                });

                let tdRange = document.createElement('td');
                tdRange.textContent = row.range;
                tr.appendChild(tdRange);

                let tdTotal = document.createElement('td');
                tdTotal.textContent = row.total;
                tr.appendChild(tdTotal);

                let tdVacios = document.createElement('td');
                tdVacios.textContent = Object.entries(row.vacios).map(([key, value]) => `${value} ${key}`).join(" ");
                tr.appendChild(tdVacios);

                let tdImo = document.createElement('td');
                tdImo.textContent = Object.entries(row.imo).map(([key, value]) => `${value} ${key}`).join(" ");
                tr.appendChild(tdImo);

                let tdFull = document.createElement('td');
                tdFull.textContent = Object.entries(row.full).map(([key, value]) => `${value} ${key}`).join(" ");
                tr.appendChild(tdFull);

                let tdConexion = document.createElement('td');
                tdConexion.textContent = Object.entries(row.conexion).map(([key, value]) => `${value} ${key}`).join(" ");
                tr.appendChild(tdConexion);

                let tdTransbordo = document.createElement('td');
                tdTransbordo.textContent = Object.entries(row.transbordos).map(([key, value]) => `${value} ${key}`).join(" ");
                tr.appendChild(tdTransbordo);

                let tdSobredimensionados = document.createElement('td');
                tdSobredimensionados.textContent = Object.entries(row.sobredimensionados).map(([key, value]) => `${value} ${key}`).join(" ");
                tr.appendChild(tdSobredimensionados);

                let tdAperturas = document.createElement('td');
                tdAperturas.textContent = Object.entries(row.aperturas).map(([key, value]) => `${value} ${key}`).join(" ");
                tr.appendChild(tdAperturas);

                let tdGrua = document.createElement('td');
                // Agregar estilos en línea para aumentar el ancho y el padding
                tdGrua.style.width = '150px'; // Establecer un ancho fijo
                tdGrua.style.padding = '10px'; // Agregar padding para aumentar el tamaño aparente
                tr.appendChild(tdGrua);

                let tdBotonVista = document.createElement('td');
                let botonVista = document.createElement('button');
                botonVista.textContent = 'Vista';
                botonVista.className = 'btn btn-info btn-sm';
                botonVista.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openShipView(tr);
                });
                tdBotonVista.appendChild(botonVista);
                tr.appendChild(tdBotonVista);

                tbody.appendChild(tr);
            });
        }

        function selectRow(row, event) {
            if (event.target.tagName === 'SELECT' || event.target.tagName === 'BUTTON') return;

            const grúas = ["Grúa 1", "Grúa 2", "Grúa 3", "Grúa 4", "Grúa 5"];
            let grúaSelect = row.querySelector('select');

            if (!grúaSelect) {
                grúaSelect = document.createElement('select');
                grúaSelect.className = 'form-select form-select-sm';
                grúaSelect.style.margin = '0 auto';
                grúaSelect.style.display = 'block';

                const emptyOption = document.createElement('option');
                emptyOption.value = '';
                emptyOption.textContent = 'Seleccionar';
                grúaSelect.appendChild(emptyOption);

                grúas.forEach((grúa, index) => {
                    const option = document.createElement('option');
                    option.value = index + 1;
                    option.textContent = grúa;
                    grúaSelect.appendChild(option);
                });

                row.cells[9].innerHTML = '';
                row.cells[9].appendChild(grúaSelect);
            }

            function aplicarColorGrúa() {
                const índiceGrúa = grúaSelect.value;
                row.style.backgroundColor = '';

                if (índiceGrúa && índiceGrúa !== '') {
                    row.style.backgroundColor = coloresGrúas[índiceGrúa - 1];
                    row.dataset.grúa = grúas[índiceGrúa - 1];
                } else {
                    delete row.dataset.grúa;
                }
            }

            aplicarColorGrúa();

            grúaSelect.addEventListener('change', aplicarColorGrúa);

            event.stopPropagation();
        }

        function deselectRow(row) {
            row.cells[9].innerHTML = '';
            row.style.backgroundColor = '';
            delete row.dataset.grúa;
        }

        function openShipView(row) {
            setTimeout(() => {
                showShipView(row);
            }, 100);
        }

        function showShipView(row) {
            const bahiaRange = row.cells[0].textContent;
            const grúaSeleccionada = row.dataset.grúa || 'No asignada';
            const shipView = window.open("", "Ship View", "width=800,height=600");
            shipView.document.body.innerHTML = `
                <h2>Vista del Barco - Bahía ${bahiaRange} - Grúa: ${grúaSeleccionada}</h2>
                <div id="containerView"></div>
            `;

            const containerView = shipView.document.getElementById("containerView");
            displayContainers(containerView, bahiaRange);
        }

        function displayContainers(containerView, bahiaRange) {
            const [startBahia, endBahia] = bahiaRange.split("-").map(Number);
            const bahiasInRange = [];
            for (let i = startBahia; i <= endBahia; i++) {
                bahiasInRange.push(i);
            }
            const containers = jsonData.filter(item => bahiasInRange.includes(parseInt(item["BA"])));

            if (containers.length === 0) {
                containerView.innerHTML = "<p>No hay contenedores para esta bahía.</p>";
                return;
            }

            const rows = [...new Set(containers.map(item => item["ROW"]))].sort();
            const tiers = [...new Set(containers.map(item => item["TIER"]))].sort();

            containerView.style.gridTemplateColumns = `repeat(${tiers.length}, 30px)`;

            let gridHTML = "";
            rows.forEach(row => {
                tiers.forEach(tier => {
                    const container = containers.find(item => item["ROW"] === row && item["TIER"] === tier);
                    const type = container ? container["TYPE"] : "";
                    gridHTML += `<div class="container-cell">${type}</div>`;
                });
            });

            containerView.innerHTML = `<div class="container-grid">${gridHTML}</div>`;
        }

function showSummary() {
  const summaryData = calculateSummary();
  const summaryHTML = generateSummaryHTML(summaryData);

  const descargaData = calculateDescargaFullEmpty(jsonData);
  const descargaHTML = generateDescargaFullEmptyHTML(descargaData);

  function showSummary() {
    // ... (tu código actual) ...

    const modal = document.getElementById('summaryModal');
    modal.style.display = "block";

    // Centrar el modal usando JavaScript
    modal.style.left = (window.innerWidth - modal.offsetWidth) / 2 + "px";
    modal.style.top = (window.innerHeight - modal.offsetHeight) / 2 + "px";

    // ... (tu código actual) ...
}
  
  const modalContent = document.getElementById('modalSummaryContent');
  modalContent.innerHTML = summaryHTML + '<br>' + descargaHTML;

  const modal = document.getElementById('summaryModal');
  modal.style.display = "block";

  const closeButton = document.querySelector('#summaryModal .close');
  closeButton.onclick = function() {
    modal.style.display = "none";
  };

  window.onclick = function(event) {
    if (event.target === modal) {
      modal.style.display = "none";
    }
  };
}
      

 let contenedores = []; // Arreglo global para almacenar todos los contenedores

function calculateDescargaFullEmpty(jsonData) {
    if (!jsonData || !Array.isArray(jsonData)) {
        console.error("Error: jsonData no está definido o no es un array.");
        return {
            descargaFull20: 0,
            descargaFull40: 0,
            descargaEmpty20: 0,
            descargaEmpty40: 0
        };
    }

    contenedores = []; // Reiniciar el arreglo global

    jsonData.forEach(item => {
        let type = item["TYPE"] || "N/A";
        type = type.trim().replace(/\s/g, '');
        const stat = item["STAT"];

        let size = type.includes("20") ? "20" : type.includes("40") ? "40" : "N/A";
        let state = (stat === "F" || stat === "L") ? "Full" : (stat === "E" || stat === "M") ? "Empty" : "N/A";

        if (state !== "N/A") { // Solo agregar contenedores con STAT válido
            contenedores.push({ size: size, state: state });
        }
    });

    // Contar contenedores de 20 pies
    let contenedores20 = contenedores.filter(c => c.size === "20");
    let descargaFull20 = contenedores20.filter(c => c.state === "Full").length;
    let descargaEmpty20 = contenedores20.filter(c => c.state === "Empty").length;

    // Contar contenedores de 40 pies
    let contenedores40 = contenedores.filter(c => c.size === "40");
    let descargaFull40 = contenedores40.filter(c => c.state === "Full").length;
    let descargaEmpty40 = contenedores40.filter(c => c.state === "Empty").length;

    let sumaContenedores = descargaFull20 + descargaFull40 + descargaEmpty20 + descargaEmpty40;
    if (sumaContenedores !== contenedores.length) {
        console.error("Error: La suma de contenedores full y vacíos no coincide con el total de contenedores.");
        console.log("Total de contenedores:", contenedores.length);
        console.log("Suma de contenedores:", sumaContenedores);
    }

    return {
        descargaFull20: descargaFull20,
        descargaFull40: descargaFull40,
        descargaEmpty20: descargaEmpty20,
        descargaEmpty40: descargaEmpty40
    };
}
      
        function generateDescargaFullEmptyHTML(data) {
        let fullHTML = '<h3 style="background-color: #f0f0f0;">Contenedores Descarga (Full)</h3><table style="width:100%; border-collapse: collapse;"><thead><tr><th style="border: 1px solid #ddd; padding: 8px; background-color: #f0f0f0;">Tamaño</th><th style="border: 1px solid #ddd; padding: 8px; background-color: #f0f0f0;">Cantidad</th><th style="border: 1px solid #ddd; padding: 8px; background-color: #f0f0f0;">TEUs</th></tr></thead><tbody>';
        let emptyHTML = '<h3 style="background-color: #f0f0f0;">Contenedores Descarga (Empty)</h3><table style="width:100%; border-collapse: collapse;"><thead><tr><th style="border: 1px solid #ddd; padding: 8px; background-color: #f0f0f0;">Tamaño</th><th style="border: 1px solid #ddd; padding: 8px; background-color: #f0f0f0;">Cantidad</th><th style="border: 1px solid #ddd; padding: 8px; background-color: #f0f0f0;">TEUs</th></tr></thead><tbody>';

        let totalFullTEUs = 0;
        let totalEmptyTEUs = 0;

        fullHTML += `<tr><td style="border: 1px solid #ddd; padding: 8px;">20 pies</td><td style="border: 1px solid #ddd; padding: 8px;">${data.descargaFull20}</td><td style="border: 1px solid #ddd; padding: 8px;">${data.descargaFull20}</td></tr>`;
        fullHTML += `<tr><td style="border: 1px solid #ddd; padding: 8px;">40 pies</td><td style="border: 1px solid #ddd; padding: 8px;">${data.descargaFull40}</td><td style="border: 1px solid #ddd; padding: 8px;">${data.descargaFull40 * 2}</td></tr>`;

        emptyHTML += `<tr><td style="border: 1px solid #ddd; padding: 8px;">20 pies</td><td style="border: 1px solid #ddd; padding: 8px;">${data.descargaEmpty20}</td><td style="border: 1px solid #ddd; padding: 8px;">${data.descargaEmpty20}</td></tr>`;
        emptyHTML += `<tr><td style="border: 1px solid #ddd; padding: 8px;">40 pies</td><td style="border: 1px solid #ddd; padding: 8px;">${data.descargaEmpty40}</td><td style="border: 1px solid #ddd; padding: 8px;">${data.descargaEmpty40 * 2}</td></tr>`;

        totalFullTEUs = data.descargaFull20 + (data.descargaFull40 * 2);
        totalEmptyTEUs = data.descargaEmpty20 + (data.descargaEmpty40 * 2);

        fullHTML += `<tr><td style="border: 1px solid #ddd; padding: 8px;"><b>Total TEUs</b></td><td style="border: 1px solid #ddd; padding: 8px;"></td><td style="border: 1px solid #ddd; padding: 8px;"><b>${totalFullTEUs}</b></td></tr>`;
        emptyHTML += `<tr><td style="border: 1px solid #ddd; padding: 8px;"><b>Total TEUs</b></td><td style="border: 1px solid #ddd; padding: 8px;"></td><td style="border: 1px solid #ddd; padding: 8px;"><b>${totalEmptyTEUs}</b></td></tr>`;

        fullHTML += '</tbody></table>';
        emptyHTML += '</tbody></table>';

        return fullHTML + emptyHTML;
    }
      
      
      
        function calculateSummary() {
            let summary = {};
            let types = new Set();

            jsonData.forEach(item => {
                const remarks = item["REMARKS"] || "N/A";
                const type = item["TYPE"] || "N/A";
                types.add(type);

                if (!summary[remarks]) {
                    summary[remarks] = {};
                }

                if (!summary[remarks][type]) {
                    summary[remarks][type] = 0;
                }

                summary[remarks][type]++;
            });

            return { summary: summary, types: Array.from(types) };
        }

        function generateSummaryHTML(summaryData) {
    let summary = summaryData.summary;
    let types = summaryData.types;

    let summaryHTML = '<h3 style="background-color: #f0f0f0;">Resumen de Carga</h3><table style="width:100%; border-collapse: collapse;"><thead><tr><th style="border: 1px solid #ddd; padding: 8px; background-color: #f0f0f0;">REMARKS</th>';

    types.forEach(type => {
        summaryHTML += `<th style="border: 1px solid #ddd; padding: 8px; background-color: #f0f0f0;">${type}</th>`;
    });

    summaryHTML += '<th style="border: 1px solid #ddd; padding: 8px; background-color: #f0f0f0;">Total general</th></tr></thead><tbody>';

    let totalPorTipo = {};

    for (const remarks in summary) {
        summaryHTML += `<tr><td style="border: 1px solid #ddd; padding: 8px;">${remarks}</td>`;

        let rowTotal = 0;
        types.forEach(type => {
            const count = summary[remarks][type] || 0;
            if (count > 0) {
                summaryHTML += `<td style="border: 1px solid #ddd; padding: 8px;">${count}</td>`;
                rowTotal += count;
                totalPorTipo[type] = (totalPorTipo[type] || 0) + count;
            } else {
                summaryHTML += `<td style="border: 1px solid #ddd; padding: 8px;"></td>`; // Celda vacía si es cero
            }
        });

        summaryHTML += `<td style="border: 1px solid #ddd; padding: 8px;">${rowTotal}</td></tr>`;
    }

    // Fila de totales por tipo
    summaryHTML += '<tr><td style="border: 1px solid #ddd; padding: 8px;"><b>Total por Tipo</b></td>';
    let granTotal = 0;
    types.forEach(type => {
        summaryHTML += `<td style="border: 1px solid #ddd; padding: 8px;"><b>${totalPorTipo[type] || 0}</b></td>`;
        granTotal += totalPorTipo[type] || 0;
    });
    summaryHTML += `<td style="border: 1px solid #ddd; padding: 8px;"><b>${granTotal}</b></td></tr>`;

    summaryHTML += '</tbody></table>';
    return summaryHTML;
}

        function openSummaryPopup(summaryHTML) {
            const width = 600;
            const height = 400;
            const left = (window.innerWidth - width) / 2;
            const top = (window.innerHeight - height) / 2;

            const popup = window.open('', 'Resumen de Carga', `width=${width},height=${height},left=${left},top=${top},menubar=no,toolbar=no,location=no,status=no,resizable=no`);
            popup.document.body.innerHTML = summaryHTML;

            popup.document.addEventListener('mousedown', function(event) {
                if (!popup.document.elementFromPoint(event.clientX, event.clientY)) {
                    popup.close();
                }
            });
        }

        function limpiarDatos() {
            jsonData = [];
            jsonDataPendientes = [];
            document.getElementById('fileBase').value = '';
            document.getElementById('filePendientes').value = '';
            document.getElementById('resultTable').getElementsByTagName('tbody')[0].innerHTML = "";
        }

        function toggleMenu() {
            document.getElementById('dropdown-menu').classList.toggle('show');
        }

        function logout() {
            alert('Cerrando sesión');
        }

        window.addEventListener('click', function(event) {
            if (!event.target.matches('.username')) {
                const dropdowns = document.getElementsByClassName("dropdown-menu");
                for (let i = 0; i < dropdowns.length; i++) {
                    const openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }
        });
          
    </script>

</body>
</html>
