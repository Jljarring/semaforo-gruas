<!DOCTYPE html>
<html lang="es">
    <script>
    const usuario = localStorage.getItem('usuario');
    console.log('Usuario en index.html:', usuario);
    if (!usuario) {
        console.log('Usuario no encontrado, redirigiendo a login.html');
        window.location.href = 'login.html';
    }
</script>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Semáforo de Grúas</title>
    <style>
        body {
            background-color: #f06d06;
            color: white;
            text-align: center;
            font-family: Arial, sans-serif;
        }
        .contenedor {
            position: relative;
            display: inline-block;
        }
        .plano {
            width: 100%;
            max-width: 1000px;
        }
        .grua {
            position: absolute;
            width: 50px;
            height: 45px;
            background-color: green;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            border-radius: 10px;
            cursor: grab;
        }
        .boton-flotante {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .boton-flotante button {
            width: 50px;
            height: 50px;
            font-size: 24px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            background-color: white;
            color: black;
        }
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: #333; /* Un fondo para la barra superior */
        }
        .top-bar button {
            background-color: #f44336; /* Rojo para el botón de cerrar sesión */
            color: white;
            border: none;
            padding: 8px 16px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="top-bar">
            <span id="nombreUsuario"></span>
            <button id="logout" onclick="cerrarSesion()">Cerrar Sesión</button>
        </div>
        <h2>Distribución de Grúas</h2>
        <div class="contenedor"></div>
        <div class="boton-flotante">
            <button id="agregarGrua">+</button>
            <button id="eliminarGrua">-</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script>
        var firebaseConfig = {
            apiKey: "AIzaSyArPPyaX0NoU2Gkax8bpj5MkWTLMsyZmYQ",
            authDomain: "estado-de-equipos-rtgs.firebaseapp.com",
            databaseURL: "https://estado-de-equipos-rtgs-default-rtdb.firebaseio.com",
            projectId: "estado-de-equipos-rtgs",
            storageBucket: "estado-de-equipos-rtgs.appspot.com",
            messagingSenderId: "927929035915",
            appId: "1:927929035915:web:7c7a5e265d8130e0ac788e"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        firebase.auth().onAuthStateChanged(function(user) {
            if (user) {
                // Usuario ha iniciado sesión
                document.getElementById('nombreUsuario').textContent = 'Usuario: ' + user.displayName || user.email; // Muestra el nombre o email
            } else {
                // Usuario no ha iniciado sesión
                window.location.href = 'login.html'; // Redirige a la página de inicio de sesión
            }
        });

        function cerrarSesion() {
            firebase.auth().signOut().then(function() {
                // Cierre de sesión exitoso
                window.location.href = 'login.html'; // Redirige a la página de inicio de sesión
            }).catch(function(error) {
                console.error('Error al cerrar sesión:', error);
            });
        }

        function cargarEstados() {
            const contenedor = document.querySelector('.contenedor');
            contenedor.innerHTML = '';

            database.ref('imagenFondo').once('value', snapshot => {
                const urlImagenFondo = snapshot.val();
                if (urlImagenFondo) {
                    const imagenPlano = document.createElement('img');
                    imagenPlano.src = urlImagenFondo;
                    imagenPlano.classList.add('plano');
                    imagenPlano.alt = 'Plano de grúas';
                    contenedor.appendChild(imagenPlano);
                }
            });

            database.ref('/').on('value', snapshot => {
                snapshot.forEach(childSnapshot => {
                    const gruaId = childSnapshot.key;
                    if (gruaId.startsWith('grua')) {
                        const { estado, top, left } = childSnapshot.val();

                        const gruaElemento = document.createElement('div');
                        gruaElemento.id = gruaId;
                        gruaElemento.classList.add('grua');
                        gruaElemento.style.top = top + 'px';
                        gruaElemento.style.left = left + 'px';
                        gruaElemento.textContent = gruaId.replace('grua', '');
                        gruaElemento.style.backgroundColor = estado || 'green';

                        let offsetX, offsetY, moviendo = false;

                        gruaElemento.addEventListener('mousedown', (e) => {
                            moviendo = true;
                            offsetX = e.clientX - gruaElemento.offsetLeft;
                            offsetY = e.clientY - gruaElemento.offsetTop;
                            gruaElemento.style.cursor = 'grabbing';
                        });

                        document.addEventListener('mousemove', (e) => {
                            if (moviendo) {
                                gruaElemento.style.left = (e.clientX - offsetX) + 'px';
                                gruaElemento.style.top = (e.clientY - offsetY) + 'px';
                            }
                        });

                        document.addEventListener('mouseup', () => {
                            if (moviendo) {
                                moviendo = false;
                                gruaElemento.style.cursor = 'grab';
                                database.ref(gruaId).update({
                                    top: parseInt(gruaElemento.style.top),
                                    left: parseInt(gruaElemento.style.left)
                                });
                            }
                        });

                        gruaElemento.addEventListener('click', () => {
                            const colores = ['green', 'yellow', 'red'];
                            const nuevoEstado = colores[(colores.indexOf(gruaElemento.style.backgroundColor) + 1) % colores.length];
                            gruaElemento.style.backgroundColor = nuevoEstado;
                            database.ref(gruaId).update({ estado: nuevoEstado });
                        });

                        contenedor.appendChild(gruaElemento);
                    }
                });
            });
        }

        document.getElementById('agregarGrua').addEventListener('click', function() {
            const nombreGrua = prompt('Ingrese el nombre de la grúa:');
            if (nombreGrua) {
                const nuevoId = 'grua' + nombreGrua;
                database.ref(nuevoId).once('value', snapshot => {
                    if (snapshot.exists()) {
                        alert('El nombre de la grúa ya existe. Por favor, ingrese otro nombre.');
                    } else {
                        database.ref(nuevoId).set({ estado: 'green', top: 100, left: 100 });
                    }
                });
            }
        });

        document.getElementById('eliminarGrua').addEventListener('click', function() {
            const gruaId= prompt('Ingrese el nombre de la grúa a eliminar:');
            if (gruaId) database.ref('grua' + gruaId).remove();
        });

        window.onload = function() {
            cargarEstados();
        };
    </script>
</body>
</html>
