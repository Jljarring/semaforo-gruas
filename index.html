<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8">
  <title>ESTADO DE EQUIPOS RTGS</title>
  <link rel="stylesheet" href="./style.css">

</head>
<body>
<!-- partial:index.partial.html -->
<!DOCTYPE html>
<html lang="es">
<head>
    
  <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Semáforo de Grúas</title>
         <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <style>
        body {
            background-color: #f06d06;
            color: white;
            text-align: center;
            font-family: Arial, sans-serif;
        }
      .tooltip {
    background-color: black !important;
    color: white;
    padding: 8px;
    border-radius: 4px;
    font-size: 12px;
    z-index: 1000;
}

        /* Barra de navegación */
        .navbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #a02a2a;
            padding: 30px 20px;
            color: white;
            font-size: 18px;
            width: 100%;
            position: center;
        }

        /* Izquierda: Logo y nombre */
        .navbar-left {
            position: absolute;
            left: 2%;
            
          transform: translateY(-50%);
            font-size: 20px;
            font-weight: bold;
        }

        .logo {
            height: 30px;
            margin-right: 10px;
        }

        /* Centro: Título */
        .navbar-center {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
          transform: translateY(-50%);
            font-size: 20px;
            font-weight: bold;
        }

        /* Derecha: Usuario */
        .navbar-right {          
            position: absolute;
            left: 93%;
            
           transform: translateY(-50%);
            font-size: 20px;
            font-weight: bold;
           
        }

        .user-menu {
            position: relative;
            cursor: pointer;
        }

        .username {
            cursor: pointer;
            white-space: nowrap;
        }

        .fas.fa-user {
            margin-right: 5px;
        }

        /* Dropdown */
        .dropdown-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            width: 150px;
            text-align: center;
            z-index: 100;
        }

        .dropdown-menu a {
            display: block;
            padding: 10px;
            color: black;
            text-decoration: none;
        }

        .dropdown-menu a:hover {
            background-color: #f1f1f1;
        }

      
      #login {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 300px;
            margin: 20px auto;
            text-align: center;
        }
      
      /* Contenedor para el formulario de inicio de sesión */
.login-container {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    background-color: #f06d06; /* Mantén el fondo naranja */
}


      
      

        #login h2 {
            margin-bottom: 20px;
            color: #333;
        }

        #login input {
            width: calc(100% - 22px);
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            outline: none;
            margin-bottom: 15px;
        }

        #login button {
            width: 100%;
            padding: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        #login button:hover {
            background-color: #0056b3;
        }

       
      
        #login p#errorMensaje {
            margin-top: 10px;
        }
        .contenedor {
            position: relative;
            display: inline-block;
        }
        .plano {
            width: 100%;
            max-width: 1000px;
        }
.grua, .stacker {
    position: absolute;
    width: 50px;
    height: 50px;
    background-color: green;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    cursor: grab;
}
function agregarStacker(nombreStacker) {
    const nuevoId = 'stacker' + Date.now();
    database.ref(nuevoId).set({
        nombre: nombreStacker,
        top: 100,
        left: 100,
        estado: 'blue'
    });
}
.stacker img {
    width: 100%;
    height: 100%;
    object-fit: contain;
}

.stacker span {
    position: absolute;
    bottom: -20px;
    width: 100%;
    text-align: center;
    color: black;
}
      
      
      
        .grua {
            position: absolute;
            width: 50px;
            height: 45px;
            background-color: green;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            border-radius: 10px;
            cursor: grab;
		  user-select: none; /* Agregar esta línea */
        }
        .boton-flotante {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .boton-flotante button {
            width: 50px;
            height: 50px;
            font-size: 24px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            background-color: white;
            color: black;
        }
        .usuario-info {
            position: fixed;
            top: 20px;
            right: 20px;
            font-size: 16px;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
        }

	            .boton-flotante-estadisticas {
            position: fixed;
            bottom: 20px;
            right: 80px;
            width: 60px;
            height: 60px;
            font-size: 24px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            background-color: lightblue;
            color: black;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-contenido {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
        }
        .cerrar-modal {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
      
      .oculto {
    display: none;
}
#modalOperadores {
    display: none; /* O block si quieres que se muestre inicialmente */
    position: fixed;
    z-index: 1;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.4); /* Fondo semi-transparente oscuro */
}

#modalOperadores .modal-contenido {
    background-color: #fefefe; /* Cambia el color de fondo a un tono más claro */
    margin: 15% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
}

#tablaOperadores {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}

#tablaOperadores th, #tablaOperadores td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
   color: #333; /* Cambia el color del texto a un tono más oscuro */
}

#tablaOperadores th {
    background-color: #f2f2f2;
}
      
      
      /* Añade estilos adicionales para mejorar el contraste del texto */
#modalOperadores h2 {
    color: #333; /* Cambia el color del título */
}

#modalOperadores input,
#modalOperadores select {
    color: #333; /* Cambia el color del texto en los campos de entrada */
}
      
      
      #modalReporteOperadores .modal-contenido {
    width: 80%;
    max-width: 800px;
    height: 200vh; /* Ajusta la altura según sea necesario */
    overflow-y: auto; /* Permite el scroll vertical si el contenido es largo */
        color: #333; /* Cambia el color del texto en los campos de entrada */
}
      
      #tablaReporteOperadores {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}

#tablaReporteOperadores th, #tablaReporteOperadores td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
}

#tablaReporteOperadores th {
    background-color: #f2f2f2;
}

      
  
.tabla-semaforo {
    width: auto; /* Ajustar el ancho automáticamente */
    max-width: 800px; /* Establecer un ancho máximo */
    margin: 20px auto; /* Centrar la tabla horizontalmente */
    border-collapse: collapse;
    font-size: 17px; /* Reducir aún más el tamaño de la fuente */
}

.tabla-semaforo th, .tabla-semaforo td {
    border: 2px solid #fff;
    padding: 3px; /* Reducir aún más el padding */
    text-align: center;
}

.tabla-semaforo th {
    background-color: #444;
}

.tabla-semaforo th:nth-child(1),
.tabla-semaforo td:nth-child(1) {
    width: 40px; /* Ajustar el ancho de la columna "Grúa" */
}

.tabla-semaforo th:nth-child(2),
.tabla-semaforo td:nth-child(2),
.tabla-semaforo th:nth-child(3),
.tabla-semaforo td:nth-child(3),
.tabla-semaforo th:nth-child(4),
.tabla-semaforo td:nth-child(4) {
    width: 60px; /* Ajustar el ancho de las columnas de estado */
}
        canvas {
            margin-top: 20px;
        }
		        .main-content {
            width: 90%; /* Ajusta el ancho según tus necesidades */
            max-width: 1200px; /* Ancho máximo para pantallas grandes */
            margin: 20px auto; /* Centrar el contenido */
            text-align: left; /* Asegura que el contenido interno también se centre */
        }
      
  .menu-desplegable {
            display: none;
            background-color: white;
            color: black;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 220px;
            position: absolute;
            top: 100%;
            left: 10px;
            margin-top: 10px;
           }
        .menu-item {
            margin-bottom: 10px;
        }
        .boton-menu {
            width: 100%;
            padding: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-align: left;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 5px;
          
          
        }
        .contenido-menu {
            display: none;
            background-color: #f1f1f1;
            padding: 10px;
            border-radius: 4px;
            flex-direction: column;
        }
        .contenido-menu a {
            display: block;
            background-color: #e0e0e0;
            padding: 8px;
            margin: 4px 0;
            border-radius: 4px;
            text-align: center;
            text-decoration: none;
            color: black;
            box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1);
        }
        .contenido-menu a:hover {
            background-color: #d6d6d6;
        }
        .menu-item:hover .contenido-menu {
            display: flex;
        }
          const style = document.createElement('style');
    style.textContent = `
        .tooltip {
            background-color: red;
            border: 1px solid black;
            padding: 5px;
            z-index: 1000;
        }
    `;
    document.head.appendChild(style);
}
      

    </style>
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
<meta name="viewport" content="width=device-width, initial-scale=1.0">

  </head>

  
<body>
  
  <!-- Menú desplegable -->
<div class="menu-desplegable" id="menuDesplegable">
    <div class="menu-item">
        <button class="boton-menu">GRÚAS</button>
        <div class="contenido-menu">
            <a href="#" id="agregarGrua">Añadir grúa</a>
            <a href="#" id="eliminarGrua">Eliminar grúa</a>
           <a href="#" id="mostrarEstadisticas">Gráfico</a>
        </div>
    </div>
    <div class="menu-item">
        <button class="boton-menu">STACKER</button>
        <div class="contenido-menu">
            <a href="#" id="agregarStacker">Añadir stacker</a>
            <a href="#" id="eliminarStacker">Eliminar stacker</a>
            <a href="#" id="mostrarEstadisticas">Gráfico</a>
        </div>
    </div>
    <div class="menu-item">
        <button class="boton-menu">OPERADORES</button>
        <div class="contenido-menu">
            <a href="#" id="operadoresGrua">Añadir Operadores</a>
            <a href="#" id="reporteOperadores">Mostrar Reporte</a>
            <a href="#" id="reporteOperadoresPDF">Generar PDF</a>
            <a href="#" id="reporteOperadoresExcel">Exportar Excel</a>
        </div>
    </div>
</div>

  <div id="navbar" class="navbar">
    <!-- Sección izquierda: Logo y título -->
    <div class="navbar-left">
        <span class="navbar-heading">Desarrollo Independiente JJLG</span>
    </div>

    <!-- Sección central: Título de la página   borre ese titulo-->
    <div class="navbar-center">
        <span class="navbar-heading"></span>
    </div>

    <!-- Sección derecha: Usuario -->
    <div class="navbar-right">
        <div class="user-menu">
            <span class="username" onclick="toggleMenu()">
                <i class="fas fa-user"></i>
                <span id="usuarioNombre">admin</span> ▼
            </span>
            <div id="dropdown-menu" class="dropdown-menu">
                <a href="#" onclick="logout()">Cerrar sesión</a>
            </div>
        </div>
    </div>
</div>


    
  
<div id="modalOperadores" class="modal">
    <div class="modal-contenido">
        <span class="cerrar-modal" id="cerrarModalOperadores">&times;</span>
        <h2>Operadores de Grúas</h2>
        <table id="tablaOperadores">
            <thead>
                <tr>
                    <th>Grúa</th>
                    <th>Estado</th>
                    <th>Operador</th>
                    <th>Bloque</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
        <button id="grabarOperadores">Grabar</button>
    </div>
</div>


<div id="modalReporteOperadores" class="modal">
    <div class="modal-contenido">
        <span class="cerrar-modal" id="cerrarModalReporteOperadores">&times;</span>
        <h2>Reporte de Operadores de Grúas</h2>
        <table id="tablaReporteOperadores">
            <thead>
                <tr>
                    <th>Grúa</th>
                    <th>Estado</th>
                    <th>Operador</th>
                    <th>Bloque</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>
</div>
  
  



    <div id="modalEstadisticas" class="modal">
	    
        <div class="modal-contenido">
            <span class="cerrar-modal" id="cerrarModal">&times;</span>
            <h2>Estadísticas de Grúas</h2>
          
	    <canvas id="graficoPastel" width="300" height="300"></canvas>
        </div>
	    
    </div>
  
  <div class="login-container">
    <div id="login">
        <h2>Iniciar Sesión</h2>
        <input type="text" id="username" placeholder="Usuario">
        <input type="password" id="password" placeholder="Contraseña">
        <button onclick="iniciarSesion()">Ingresar</button>
        <p id="errorMensaje" style="color: red;"></p>
    </div>
</div>

    <div id="app" style="display: none;">
        <div class="usuario-info" id="usuarioInfo" style="display: none;">
            <span id="usuarioNombre"></span>
      
        </div>
        <h2>Distribución de Grúas</h2>
        <div class="contenedor"></div>
        
    </div>
	
    <table class="tabla-semaforo" id="tablaSemaforos">
        <thead>
            <tr>
                <th>Grúa</th>
                <th>Mantenimiento (Rojo)</th>
                <th>Operativa (Verde)</th>
                <th>Standby (Azul)</th>
            </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
            <tr>
                <td><strong>Total</strong></td>
                <td id="totalRojo">0</td>
                <td id="totalVerde">0</td>
                <td id="totalAzul">0</td>
            </tr>
        </tfoot>
    </table>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
      

        // Configuración de Firebase
        var firebaseConfig = {
            apiKey: "AIzaSyArPPyaX0NoU2Gkax8bpj5MkWTLMsyZmYQ",
            authDomain: "estado-de-equipos-rtgs.firebaseapp.com",
            databaseURL: "https://estado-de-equipos-rtgs-default-rtdb.firebaseio.com",
            projectId: "estado-de-equipos-rtgs",
            storageBucket: "estado-de-equipos-rtgs.appspot.com",
            messagingSenderId: "927929035915",
            appId: "1:927929035915:web:7c7a5e265d8130e0ac788e"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Verificar si hay sesión activa


        function iniciarSesion() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
          if (username === 'invitado' && password === 'invitado') {
                // Redirigir a movimientospatio.html si es un usuario invitado
                window.location.href = 'gestion.html';
          } else {
            database.ref('usuarios').once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        const userData = snapshot.val();
                        if (userData.usuario === username && userData.contrasena === password) {
                            localStorage.setItem('usuario', username);
                            mostrarApp();
                        } else {
                            document.getElementById('errorMensaje').textContent = "Usuario o contraseña incorrectos.";
                        }
                    } else {
                        document.getElementById('errorMensaje').textContent = "Usuario o contraseña incorrectos.";
                    }
                })
                .catch(error => console.error("Error al acceder a Firebase:", error));
        }
          }

        let miGrafico;
        const modalEstadisticas = document.getElementById('modalEstadisticas');

        document.getElementById('mostrarEstadisticas').addEventListener('click', () => {
            mostrarEstadisticas();
        });

        document.getElementById('cerrarModal').addEventListener('click', () => {
            modalEstadisticas.style.display = 'none';
        });

          function mostrarEstadisticas() {
            const estados = { green: 0, red: 0, blue: 0 };
              const gruas = document.querySelectorAll('.grua, .stacker');
            gruas.forEach(grua => {
                const color = grua.style.backgroundColor;
                if (estados[color] !== undefined) {
                    estados[color]++;
            }});

            const ctx = document.getElementById('graficoPastel').getContext('2d');

            if (miGrafico) {
                miGrafico.destroy();
            }

            miGrafico = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Operativo (Verde)', 'Mantenimiento (Rojo)', 'Standby (Azul)'],
                    datasets: [{
                        data: [estados.green, estados.red, estados.blue],
                        backgroundColor: ['green', 'red', 'blue']
                    }]
                }
            });

            modalEstadisticas.style.display = 'block';
        }
	    
function mostrarApp() {
    document.getElementById('login').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    document.getElementById('usuarioInfo').style.display = 'flex';
    document.getElementById('usuarioNombre').textContent = localStorage.getItem('usuario');
     document.getElementById('tablaSemaforos').style.display = 'table';
    document.getElementById("navbar").style.display = 'block';
      document.getElementById('mostrarEstadisticas').style.display = 'block'; // Agregar esta línea
   document.querySelector('.login-container').classList.add('oculto'); // Añade esta línea
  document.getElementById('menuDesplegable').style.display = 'block';
    cargarEstados();
}

    document.addEventListener("DOMContentLoaded", function () {
      var usuario = localStorage.getItem("usuario");
        if (usuario) {
            document.getElementById("usuarioNombre").textContent = usuario;
            document.getElementById("navbar").style.display = "block";
     
            mostrarApp(); // Llamar a mostrarApp() para cargar la aplicación si hay usuario
        } else {
            document.getElementById("navbar").style.display = "none";
           document.getElementById('tablaSemaforos').style.display = 'none';
            mostrarFormularioLogin();
        }

});
      
  
      
      function toggleMenu() {
    const menu = document.getElementById('dropdown-menu');
          
    menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        document.getElementById('dropdown-menu').classList.toggle('hidden');
}

  
        function logout() {
          alert("Cerrando sesión...");
            localStorage.removeItem('usuario');
            document.getElementById('login').style.display = 'block';
            document.getElementById('app').style.display = 'none';
	        document.getElementById('menuDesplegable').style.display = 'none';
           document.getElementById('tablaSemaforos').style.display = 'none'; // Agregar esta línea
           document.getElementById('dropdown-menu').style.display = 'none';
          document.getElementById('mostrarEstadisticas').style.display = 'none'; // Agregar esta línea     
          document.getElementById("navbar").style.display = "none"; // Ocultar navbar
           document.getElementById('tablaSemaforos').style.display = 'none';
          mostrarFormularioLogin(); // Mostrar formulario de login en la misma página
              // Limpiar la tabla
          const tablaBody = document.querySelector('#tablaSemaforos tbody');               
          tablaBody.innerHTML = '';
          
            // Limpiar campos del formulario de inicio de sesión
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('errorMensaje').textContent = ''; // Limpiar mensaje de error
          
           document.querySelector('.login-container').classList.remove('oculto'); // Añade esta línea
        }
      
      // Función para mostrar el formulario de login
function mostrarFormularioLogin() {
    document.getElementById("login").style.display = "block";
}

 function abrirVentanaEmergente() {
            const numeroGrua = prompt("Ingrese el número de la grúa:");
            if (numeroGrua) {
                agregarGrua(numeroGrua);
            } else {
                alert("El número de grúa es obligatorio.");
            }
        }
      
        function agregarGrua(numeroGrua) {
            const nuevoId = 'grua' + Date.now();
            database.ref(nuevoId).set({
                numero: numeroGrua,
                top: 50,
                left: 50,
                estado: 'green'
            });
        }

        function agregarStacker(nombreStacker) {
            const nuevoId = 'stacker' + Date.now();
            database.ref(nuevoId).set({
                nombre: nombreStacker,
                top: 100,
                left: 100,
                estado: 'blue'
            });
        }

      function mostrarModalOperadores() {
          const modal = document.getElementById('modalOperadores');
          modal.style.display = 'block';
          llenarTablaOperadores();
      }

    function llenarTablaOperadores() {
    const tablaBody = document.querySelector('#tablaOperadores tbody');
    tablaBody.innerHTML = '';

    database.ref('/').once('value', snapshot => {
        snapshot.forEach(childSnapshot => {
            const maquinaId = childSnapshot.key;
            const maquina = childSnapshot.val();
            if (maquinaId.startsWith('grua')) {
                const fila = document.createElement('tr');
                fila.innerHTML = `
                    <td>${maquina.numero || maquinaId.replace('grua', '')}</td>
                    <td>
                        <select data-maquina-id="${maquinaId}" data-campo="estado">
                            <option value="green" ${maquina.estado === 'green' ? 'selected' : ''}>Operativa</option>
                            <option value="blue" ${maquina.estado === 'blue' ? 'selected' : ''}>Standby</option>
                            <option value="red" ${maquina.estado === 'red' ? 'selected' : ''}>Mantenimiento</option>
                        </select>
                    </td>
                    <td>
                        <input type="text" value="${maquina.operador || ''}" data-maquina-id="${maquinaId}" data-campo="operador">
                    </td>
                    <td>
                        <input type="text" value="${maquina.bloque || ''}" data-maquina-id="${maquinaId}" data-campo="bloque">
                    </td>
                `;
                tablaBody.appendChild(fila);
            } else if (maquinaId.startsWith('stacker')) {
                const fila = document.createElement('tr');
                fila.innerHTML = `
                    <td>${maquina.nombre}</td>
                    <td>
                        <select data-maquina-id="${maquinaId}" data-campo="estado">
                            <option value="green" ${maquina.estado === 'green' ? 'selected' : ''}>Operativa</option>
                            <option value="blue" ${maquina.estado === 'blue' ? 'selected' : ''}>Standby</option>
                            <option value="red" ${maquina.estado === 'red' ? 'selected' : ''}>Mantenimiento</option>
                        </select>
                    </td>
                    <td>
                        <input type="text" value="${maquina.operador || ''}" data-maquina-id="${maquinaId}" data-campo="operador">
                    </td>
                    <td>
                        <input type="text" value="${maquina.bloque || ''}" data-maquina-id="${maquinaId}" data-campo="bloque">
                    </td>
                `;
                tablaBody.appendChild(fila);
            }
        });
    });
}
      
      function generarReporteGruas() {
    const tablaBody = document.querySelector('#tablaReporteGruas tbody');
    tablaBody.innerHTML = '';

    database.ref('/').once('value', snapshot => {
        snapshot.forEach(childSnapshot => {
            const maquinaId = childSnapshot.key;
            if (maquinaId.startsWith('grua')) {
                const maquina = childSnapshot.val();
                const fila = document.createElement('tr');
                fila.innerHTML = `
                    <td>${maquina.numero || maquinaId.replace('grua', '')}</td>
                    <td>${maquina.estado}</td>
                    <td>${maquina.operador || 'N/A'}</td>
                    <td>${maquina.bloque || 'N/A'}</td>
                `;
                tablaBody.appendChild(fila);
            }
        });
        document.getElementById('modalReporteGruas').style.display = 'block';
    });
}

function generarReporteStackers() {
    const tablaBody = document.querySelector('#tablaReporteStackers tbody');
    tablaBody.innerHTML = '';

    database.ref('/').once('value', snapshot => {
        snapshot.forEach(childSnapshot => {
            const maquinaId = childSnapshot.key;
            if (maquinaId.startsWith('stacker')) {
                const maquina = childSnapshot.val();
                const fila = document.createElement('tr');
                fila.innerHTML = `
                    <td>${maquina.nombre}</td>
                    <td>${maquina.estado}</td>
                `;
                tablaBody.appendChild(fila);
            }
        });
        document.getElementById('modalReporteStackers').style.display = 'block';
    });
}

function generarReporteGeneral() {
    const tablaBody = document.querySelector('#tablaReporteGeneral tbody');
    tablaBody.innerHTML = '';

    database.ref('/').once('value', snapshot => {
        snapshot.forEach(childSnapshot => {
            const maquinaId = childSnapshot.key;
            const maquina = childSnapshot.val();
            if (maquinaId.startsWith('grua')) {
                const fila = document.createElement('tr');
                fila.innerHTML = `
                    <td>Grúa</td>
                    <td>${maquina.numero || maquinaId.replace('grua', '')}</td>
                    <td>${maquina.estado}</td>
                    <td>${maquina.operador || 'N/A'}</td>
                    <td>${maquina.bloque || 'N/A'}</td>
                `;
                tablaBody.appendChild(fila);
            } else if (maquinaId.startsWith('stacker')) {
                const fila = document.createElement('tr');
                fila.innerHTML = `
                    <td>Stacker</td>
                    <td>${maquina.nombre}</td>
                    <td>${maquina.estado}</td>
                    <td></td>
                    <td></td>
                `;
                tablaBody.appendChild(fila);
            }
        });
        document.getElementById('modalReporteGeneral').style.display = 'block';
    });
}
      
      
      
      

    function generarReporteOperadores() {
    const tablaBody = document.querySelector('#tablaReporteOperadores tbody');
    tablaBody.innerHTML = ''; // Limpiar la tabla

    database.ref('/').once('value', snapshot => {
        const maquinas = []; // Usaremos un array para grúas y stackers
        snapshot.forEach(childSnapshot => {
            const maquinaId = childSnapshot.key;
            const maquina = childSnapshot.val();
            if (maquinaId.startsWith('grua')) {
                maquinas.push({
                    tipo: 'Grúa',
                    id: maquinaId,
                    numero: maquina.numero || maquinaId.replace('grua', ''),
                    estado: maquina.estado,
                    operador: maquina.operador || 'N/A',
                    bloque: maquina.bloque || 'N/A'
                });
            } else if (maquinaId.startsWith('stacker')) {
                maquinas.push({
                    tipo: 'Stacker',
                    id: maquinaId,
                    nombre: maquina.nombre,
                    estado: maquina.estado,
                    operador: maquina.operador || 'N/A',
                    bloque: maquina.bloque || 'N/A'
                });
            }
        });

        // Ordenar las grúas por número y los stackers por nombre
        maquinas.sort((a, b) => {
            if (a.tipo === 'Grúa' && b.tipo === 'Grúa') {
                return parseInt(a.numero) - parseInt(b.numero);
            } else if (a.tipo === 'Stacker' && b.tipo === 'Stacker') {
                return a.nombre.localeCompare(b.nombre);
            } else {
                return a.tipo.localeCompare(b.tipo); // Grúas primero, luego stackers
            }
        });

        maquinas.forEach(maquina => {
            let estadoTexto = '';
            switch (maquina.estado) {
                case 'red':
                    estadoTexto = 'Mantenimiento';
                    break;
                case 'blue':
                    estadoTexto = 'Standby';
                    break;
                case 'green':
                    estadoTexto = 'Operativa';
                    break;
                default:
                    estadoTexto = 'Desconocido';
            }

            const fila = document.createElement('tr');
            if (maquina.tipo === 'Grúa') {
                fila.innerHTML = `
                    <td>${maquina.numero}</td>
                    <td>${estadoTexto}</td>
                    <td>${maquina.operador}</td>
                    <td>${maquina.bloque}</td>
                `;
            } else if (maquina.tipo === 'Stacker') {
                fila.innerHTML = `
                    <td>${maquina.nombre}</td>
                    <td>${estadoTexto}</td>
                    <td>${maquina.operador}</td>
                    <td>${maquina.bloque}</td>
                `;
            }
            tablaBody.appendChild(fila);
        });

        document.getElementById('modalReporteOperadores').style.display = 'block';
    });
}
      

      
      
      
      document.getElementById('reporteOperadores').addEventListener('click', generarReporteOperadores);
      document.getElementById('cerrarModalReporteOperadores').addEventListener('click', () => {
    document.getElementById('modalReporteOperadores').style.display = 'none';
});
     
      document.addEventListener("DOMContentLoaded", function () {
    document.getElementById("agregarGrua").addEventListener("click", function (event) {
        event.preventDefault();
        abrirVentanaEmergente();
    });


    document.getElementById("operadoresGrua").addEventListener("click", function (event) {
        event.preventDefault();
        mostrarModalOperadores();
    });

    document.getElementById("reporteOperadores").addEventListener("click", function (event) {
        event.preventDefault();
        generarReporteOperadores();
    });


    document.getElementById("reporteOperadoresExcel").addEventListener("click", function (event) {
        event.preventDefault();
        generarReporteOperadoresExcel();
    });
});
      
      
function actualizarEstado(select, maquinaId) {
    const estado = select.value;
    database.ref(maquinaId).update({ estado: estado });
}
      
document.getElementById('grabarOperadores').addEventListener('click', () => {
    const inputs = document.querySelectorAll('#tablaOperadores input, #tablaOperadores select');
    inputs.forEach(input => {
        const maquinaId = input.dataset.maquinaId; // Usar maquinaId en lugar de gruaId
        const campo = input.dataset.campo;
        const valor = input.value;
        if (maquinaId) { // Asegurarse de que maquinaId existe
            database.ref(maquinaId).update({ [campo]: valor });
        }
    });
    document.getElementById('modalOperadores').style.display = 'none';
});
 
         
      
      function generarReporteOperadoresExcel() {
    const wb = XLSX.utils.book_new();
    const wsData = [["Grúa", "Estado", "Operador", "Bloque"]];

    database.ref('/').once('value', snapshot => {
        snapshot.forEach(childSnapshot => {
            const gruaId = childSnapshot.key;
            if (gruaId.startsWith('grua')) {
                const grua = childSnapshot.val();
                wsData.push([
                    grua.numero || gruaId.replace('grua', ''),
                    grua.estado,
                    grua.operador || 'N/A',
                    grua.bloque || 'N/A'
                ]);
            }
        });

        const ws = XLSX.utils.aoa_to_sheet(wsData);
        XLSX.utils.book_append_sheet(wb, ws, "Operadores");
        XLSX.writeFile(wb, "reporte_operadores.xlsx");
    });
}
      
  

function cargarEstados() {
    const contenedor = document.querySelector('.contenedor');
    contenedor.innerHTML = '';
    let gruasEliminadas = []; // Declaración de gruasEliminadas

    // Cargar la imagen de fondo
    database.ref('imagenFondo').once('value', snapshot => {
        const urlImagenFondo = snapshot.val();
        if (urlImagenFondo) {
            const imagenPlano = document.createElement('img');
            imagenPlano.src = urlImagenFondo;
            imagenPlano.classList.add('plano');
            imagenPlano.alt = 'Plano de grúas';
            contenedor.appendChild(imagenPlano);
        }
    });


  
  
      document.getElementById('eliminarGrua').addEventListener('click', () => {
        const gruaSeleccionada = document.querySelector('.grua.seleccionada');
        if (gruaSeleccionada) {
            database.ref(gruaSeleccionada.id).remove();
        }
    });
    
    // Manejar la eliminación de grúas/stackers
    database.ref('/').on('child_removed', snapshot => {
        const maquinaId = snapshot.key;
        const maquinaElemento = document.getElementById(maquinaId);
        if (maquinaElemento) {
            let nombreMaquina = "";
            if (maquinaId.startsWith('grua')) {
                nombreMaquina = maquinaElemento.textContent || maquinaId.replace('grua', '');
            } else if (maquinaId.startsWith('stacker')) {
                nombreMaquina = maquinaElemento.textContent;
            }
            maquinaElemento.remove();
            actualizarTablaSemaforos();
            alert(`Máquina ${nombreMaquina} eliminada.`);
            gruasEliminadas.push(maquinaId); // Agregar a la lista de eliminados
        }
    });
    // Manejar cambios en grúas/stackers
    database.ref('/').on('child_changed', snapshot => {
        const maquinaId = snapshot.key;
        if (!gruasEliminadas.includes(maquinaId)) {
            const maquinaElemento = document.getElementById(maquinaId);
            if (maquinaElemento) {
                const { estado, top, left } = snapshot.val();
                maquinaElemento.style.top = top + 'px';
                maquinaElemento.style.left = left + 'px';
                maquinaElemento.style.backgroundColor = estado || 'green';
                actualizarTablaSemaforos();
            }
        }
    });

    // Manejar la adición de grúas/stackers
    database.ref('/').on('child_added', snapshot => {
        const maquinaId = snapshot.key;
        const { estado, top, left, numero, nombre, operador, bloque } = snapshot.val();

        let maquinaElemento;
        if (maquinaId.startsWith('grua')) {
            maquinaElemento = document.createElement('div');
            maquinaElemento.id = maquinaId;
            maquinaElemento.classList.add('grua');
            maquinaElemento.textContent = numero || maquinaId.replace('grua', '');
        } else if (maquinaId.startsWith('stacker')) {
            maquinaElemento = document.createElement('div');
            maquinaElemento.id = maquinaId;
            maquinaElemento.classList.add('stacker');
            maquinaElemento.textContent = nombre;
        }

        if (maquinaElemento) {
            maquinaElemento.style.top = top + 'px';
            maquinaElemento.style.left = left + 'px';
            maquinaElemento.style.backgroundColor = estado || 'green';
            maquinaElemento.dataset.operador = operador || 'N/A';
            maquinaElemento.dataset.bloque = bloque || 'N/A';

            // Tooltip
            maquinaElemento.addEventListener('mouseover', (e) => {
                const tooltip = document.createElement('div');
                tooltip.classList.add('tooltip');
                tooltip.innerHTML = `
                    <div style="text-align: center;">
                        <span>Operador: ${maquinaElemento.dataset.operador.replace(',', '')}</span><br>
                        <span>Bloque: ${maquinaElemento.dataset.bloque.replace(',', '')}</span>
                    </div>
                `;
                tooltip.style.position = 'flex';
                tooltip.style.left = (maquinaElemento.offsetLeft + maquinaElemento.offsetWidth + 10) + 'px';
                tooltip.style.top = maquinaElemento.offsetTop + 'px';
                maquinaElemento.parentElement.appendChild(tooltip);

                maquinaElemento.addEventListener('mouseout', () => {
                    tooltip.remove();
                }, { once: true });
            });

            // Movimiento
            let offsetX, offsetY, moviendo = false;
            let toqueCount = 0;

            maquinaElemento.addEventListener('mousedown', (e) => {
                e.preventDefault();
                moviendo = true;
                offsetX = e.clientX - maquinaElemento.offsetLeft;
                offsetY = e.clientY - maquinaElemento.offsetTop;
                maquinaElemento.style.cursor = 'grabbing';
            });

            document.addEventListener('mousemove', (e) => {
                if (moviendo) {
                    maquinaElemento.style.left = (e.clientX - offsetX) + 'px';
                    maquinaElemento.style.top = (e.clientY - offsetY) + 'px';
                    database.ref(maquinaId).update({
                        top: parseInt(maquinaElemento.style.top),
                        left: parseInt(maquinaElemento.style.left)
                    });
                }
            });

            document.addEventListener('mouseup', () => {
                if (moviendo) {
                    moviendo = false;
                    maquinaElemento.style.cursor = 'grab';
                }
            });

            // Touch events
            maquinaElemento.addEventListener('touchstart', (e) => {
                toqueCount++;
                if (toqueCount === 3) {
                    const colores = ['green', 'blue', 'red'];
                    const colorActual = maquinaElemento.style.backgroundColor;
                    const nuevoColor = colores[(colores.indexOf(colorActual) + 1) % colores.length];
                    maquinaElemento.style.backgroundColor = nuevoColor;
                    database.ref(maquinaId).update({ estado: nuevoColor });
                    toqueCount = 0;
                }
                moviendo = true;
                offsetX = e.touches[0].clientX - maquinaElemento.offsetLeft;
                offsetY = e.touches[0].clientY - maquinaElemento.offsetTop;
            });

            document.addEventListener('touchmove', (e) => {
                if (moviendo) {
                    const touch = e.touches[0];
                    maquinaElemento.style.left = (touch.clientX - offsetX) + 'px';
                    maquinaElemento.style.top = (touch.clientY - offsetY) + 'px';
                    database.ref(maquinaId).update({
                        top: parseInt(maquinaElemento.style.top),
                        left: parseInt(maquinaElemento.style.left)
                    });
                }
            });

            document.addEventListener('touchend', () => {
                if (moviendo) {
                    moviendo = false;
                }
            });

            // Double click para cambiar el estado
            maquinaElemento.addEventListener('dblclick', () => {
                const colores = ['green', 'blue', 'red'];
                const nuevoEstado = colores[(colores.indexOf(maquinaElemento.style.backgroundColor) + 1) % colores.length];
                maquinaElemento.style.backgroundColor = nuevoEstado;
                database.ref(maquinaId).update({ estado: nuevoEstado });
            });

            contenedor.appendChild(maquinaElemento);
            actualizarTablaSemaforos();
        }
    });

 
      // Eventos de contenedor
    contenedor.addEventListener('click', (e) => {
        if (e.target.classList.contains('grua') || e.target.classList.contains('stacker')) {
            document.querySelectorAll('.grua, .stacker').forEach(maquina => maquina.classList.remove('seleccionada'));
            e.target.classList.add('seleccionada');
        }
    });

    // Botones para stackers
    document.getElementById('agregarStacker').addEventListener('click', () => {
        const nombreStacker = prompt("Ingrese el nombre del stacker:");
        if (nombreStacker) {
            agregarStacker(nombreStacker);
        }
    });

    document.getElementById('eliminarStacker').addEventListener('click', () => {
        const stackerSeleccionado = document.querySelector('.stacker.seleccionada');
        if (stackerSeleccionado) {
            database.ref(stackerSeleccionado.id).remove();
        }
    });
    actualizarTablaSemaforos();
}
      document.addEventListener('click', function(event) {
      const menu = document.getElementById('dropdown-menu');
      const userMenu = document.querySelector('.user-menu');

    if (menu.style.display === 'block' && !userMenu.contains(event.target)) {
        menu.style.display = 'none';
    }
});
		
        function actualizarTablaSemaforos() {
            const tablaBody = document.querySelector('#tablaSemaforos tbody');
            tablaBody.innerHTML = ''; // Limpiar la tabla
            
           //const gruas = document.querySelectorAll('.grua');   //codigo anterior si falla ub icar         
            const gruas = Array.from(document.querySelectorAll('.grua')); // Obtener las grúas como un array

              // Ordenar las grúas por número
              gruas.sort((a, b) => {
              const numeroA = parseInt(a.textContent);
              const numeroB = parseInt(b.textContent);
              return numeroA - numeroB;
              });
          
           
            const estados = { green: 0, red: 0, blue: 0 };
            gruas.forEach(grua => {
                const color = grua.style.backgroundColor;
                const numero = grua.textContent;

                // Contar las grúas por color
                if (color === 'green') estados.green++;
                else if (color === 'red') estados.red++;
                else if (color === 'blue') estados.blue++;

                // Crear una fila para cada grúa
                const fila = document.createElement('tr');
                fila.innerHTML = `
                    <td>${numero}</td>
                    <td>${color === 'red' ? 'X' : ''}</td>
                    <td>${color === 'green' ? 'X' : ''}</td>
                    <td>${color === 'blue' ? 'X' : ''}</td>
                `;
                tablaBody.appendChild(fila);
            });

            // Actualizar los totales en la tabla
            document.getElementById('totalRojo').textContent = estados.red;
            document.getElementById('totalVerde').textContent = estados.green;
            document.getElementById('totalAzul').textContent = estados.blue;
        }


			
    </script>

</body>
</html>
<!-- partial -->
  <script  src="./script.js"></script>

</body>
</html>
