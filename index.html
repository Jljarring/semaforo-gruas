<!DOCTYPE html>
<html lang="es">
<head>
    
  <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Semáforo de Grúas</title>
         <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <style>
        body {
            background-color: #f06d06;
            color: white;
            text-align: center;
            font-family: Arial, sans-serif;
        }

        /* Barra de navegación */
        .navbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #a02a2a;
            padding: 30px 20px;
            color: white;
            font-size: 18px;
            width: 100%;
            position: center;
        }

        /* Izquierda: Logo y nombre */
        .navbar-left {
            position: absolute;
            left: 2%;
            
          transform: translateY(-50%);
            font-size: 20px;
            font-weight: bold;
        }

        .logo {
            height: 30px;
            margin-right: 10px;
        }

        /* Centro: Título */
        .navbar-center {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
          transform: translateY(-50%);
            font-size: 20px;
            font-weight: bold;
        }

        /* Derecha: Usuario */
        .navbar-right {          
            position: absolute;
            left: 90%;
            
           transform: translateY(-50%);
            font-size: 20px;
            font-weight: bold;
           
        }

        .user-menu {
            position: relative;
            cursor: pointer;
        }

        .username {
            cursor: pointer;
            white-space: nowrap;
        }

        .fas.fa-user {
            margin-right: 5px;
        }

        /* Dropdown */
        .dropdown-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            width: 150px;
            text-align: center;
            z-index: 100;
        }

        .dropdown-menu a {
            display: block;
            padding: 10px;
            color: black;
            text-decoration: none;
        }

        .dropdown-menu a:hover {
            background-color: #f1f1f1;
        }

      
      #login {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 300px;
            margin: 20px auto;
            text-align: center;
        }
      
      /* Contenedor para el formulario de inicio de sesión */
.login-container {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    background-color: #f06d06; /* Mantén el fondo naranja */
}


      
      

        #login h2 {
            margin-bottom: 20px;
            color: #333;
        }

        #login input {
            width: calc(100% - 22px);
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            outline: none;
            margin-bottom: 15px;
        }

        #login button {
            width: 100%;
            padding: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        #login button:hover {
            background-color: #0056b3;
        }

      
      
      
      
      
        #login p#errorMensaje {
            margin-top: 10px;
        }
        .contenedor {
            position: relative;
            display: inline-block;
        }
        .plano {
            width: 100%;
            max-width: 1000px;
        }
        .grua {
            position: absolute;
            width: 50px;
            height: 45px;
            background-color: green;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            border-radius: 10px;
            cursor: grab;
		  user-select: none; /* Agregar esta línea */
        }
        .boton-flotante {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .boton-flotante button {
            width: 50px;
            height: 50px;
            font-size: 24px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            background-color: white;
            color: black;
        }
        .usuario-info {
            position: fixed;
            top: 20px;
            right: 20px;
            font-size: 16px;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
        }

	            .boton-flotante-estadisticas {
            position: fixed;
            bottom: 20px;
            right: 80px;
            width: 60px;
            height: 60px;
            font-size: 24px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            background-color: lightblue;
            color: black;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-contenido {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
        }
        .cerrar-modal {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
      
      .oculto {
    display: none;
}
		
  
.tabla-semaforo {
    width: auto; /* Ajustar el ancho automáticamente */
    max-width: 800px; /* Establecer un ancho máximo */
    margin: 20px auto; /* Centrar la tabla horizontalmente */
    border-collapse: collapse;
    font-size: 17px; /* Reducir aún más el tamaño de la fuente */
}

.tabla-semaforo th, .tabla-semaforo td {
    border: 2px solid #fff;
    padding: 3px; /* Reducir aún más el padding */
    text-align: center;
}

.tabla-semaforo th {
    background-color: #444;
}

.tabla-semaforo th:nth-child(1),
.tabla-semaforo td:nth-child(1) {
    width: 40px; /* Ajustar el ancho de la columna "Grúa" */
}

.tabla-semaforo th:nth-child(2),
.tabla-semaforo td:nth-child(2),
.tabla-semaforo th:nth-child(3),
.tabla-semaforo td:nth-child(3),
.tabla-semaforo th:nth-child(4),
.tabla-semaforo td:nth-child(4) {
    width: 60px; /* Ajustar el ancho de las columnas de estado */
}
        canvas {
            margin-top: 20px;
        }
		        .main-content {
            width: 90%; /* Ajusta el ancho según tus necesidades */
            max-width: 1200px; /* Ancho máximo para pantallas grandes */
            margin: 20px auto; /* Centrar el contenido */
            text-align: center; /* Asegura que el contenido interno también se centre */
        }
    </style>
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

  <div id="navbar" class="navbar">
    <!-- Sección izquierda: Logo y título -->
    <div class="navbar-left">
        <span class="navbar-heading">Desarrollo Independiente JJLG</span>
    </div>

    <!-- Sección central: Título de la página   borre ese titulo-->
    <div class="navbar-center">
        <span class="navbar-heading"></span>
    </div>

    <!-- Sección derecha: Usuario -->
    <div class="navbar-right">
        <div class="user-menu">
            <span class="username" onclick="toggleMenu()">
                <i class="fas fa-user"></i>
                <span id="usuarioNombre">admin</span> ▼
            </span>
            <div id="dropdown-menu" class="dropdown-menu">
                <a href="#" onclick="logout()">Cerrar sesión</a>
            </div>
        </div>
    </div>
</div>


    <button class="boton-flotante-estadisticas" id="mostrarEstadisticas"></button>
  





    <div id="modalEstadisticas" class="modal">
	    
        <div class="modal-contenido">
            <span class="cerrar-modal" id="cerrarModal">&times;</span>
            <h2>Estadísticas de Grúas</h2>
          
	    <canvas id="graficoPastel" width="300" height="300"></canvas>
        </div>
	    
    </div>
  
  <div class="login-container oculto">
    <div id="login">
        <h2>Iniciar Sesión</h2>
        <input type="text" id="username" placeholder="Usuario">
        <input type="password" id="password" placeholder="Contraseña">
        <button onclick="iniciarSesion()">Ingresar</button>
        <p id="errorMensaje" style="color: red;"></p>
    </div>
</div>

    <div id="app" style="display: none;">
        <div class="usuario-info" id="usuarioInfo" style="display: none;">
            <span id="usuarioNombre"></span>
      
        </div>
        <h2>Distribución de Grúas</h2>
        <div class="contenedor"></div>
        <div class="boton-flotante">
            <button id="agregarGrua">+</button>
            <button id="eliminarGrua">-</button>
        </div>
    </div>
	
    <table class="tabla-semaforo" id="tablaSemaforos">
        <thead>
            <tr>
                <th>Grúa</th>
                <th>Mantenimiento (Rojo)</th>
                <th>Operativa (Verde)</th>
                <th>Standby (Azul)</th>
            </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
            <tr>
                <td><strong>Total</strong></td>
                <td id="totalRojo">0</td>
                <td id="totalVerde">0</td>
                <td id="totalAzul">0</td>
            </tr>
        </tfoot>
    </table>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
      

        // Configuración de Firebase
        var firebaseConfig = {
            apiKey: "AIzaSyArPPyaX0NoU2Gkax8bpj5MkWTLMsyZmYQ",
            authDomain: "estado-de-equipos-rtgs.firebaseapp.com",
            databaseURL: "https://estado-de-equipos-rtgs-default-rtdb.firebaseio.com",
            projectId: "estado-de-equipos-rtgs",
            storageBucket: "estado-de-equipos-rtgs.appspot.com",
            messagingSenderId: "927929035915",
            appId: "1:927929035915:web:7c7a5e265d8130e0ac788e"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Verificar si hay sesión activa
    window.onload = function() {
    const tablaBody = document.querySelector('#tablaSemaforos tbody');
    tablaBody.innerHTML = '';

    if (localStorage.getItem('usuario')) {
        mostrarApp();
    } else {
        document.getElementById('mostrarEstadisticas').style.display = 'none';
        document.getElementById('tablaSemaforos').style.display = 'none';
    }
};

        function iniciarSesion() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            database.ref('usuarios').once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        const userData = snapshot.val();
                        if (userData.usuario === username && userData.contrasena === password) {
                            localStorage.setItem('usuario', username);
                            mostrarApp();
                        } else {
                            document.getElementById('errorMensaje').textContent = "Usuario o contraseña incorrectos.";
                        }
                    } else {
                        document.getElementById('errorMensaje').textContent = "Usuario o contraseña incorrectos.";
                    }
                })
                .catch(error => console.error("Error al acceder a Firebase:", error));
        }

        let miGrafico;
        const modalEstadisticas = document.getElementById('modalEstadisticas');

        document.getElementById('mostrarEstadisticas').addEventListener('click', () => {
            mostrarEstadisticas();
        });

        document.getElementById('cerrarModal').addEventListener('click', () => {
            modalEstadisticas.style.display = 'none';
        });

          function mostrarEstadisticas() {
            const estados = { green: 0, red: 0, blue: 0 };
            const gruas = document.querySelectorAll('.grua');
            gruas.forEach(grua => {
                const color = grua.style.backgroundColor;
                if (estados[color] !== undefined) {
                    estados[color]++;
            }});

            const ctx = document.getElementById('graficoPastel').getContext('2d');

            if (miGrafico) {
                miGrafico.destroy();
            }

            miGrafico = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Operativo (Verde)', 'Mantenimiento (Rojo)', 'Standby (Azul)'],
                    datasets: [{
                        data: [estados.green, estados.red, estados.blue],
                        backgroundColor: ['green', 'red', 'blue']
                    }]
                }
            });

            modalEstadisticas.style.display = 'block';
        }

	    
function mostrarApp() {
    document.getElementById('login').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    document.getElementById('usuarioInfo').style.display = 'flex';
    document.getElementById('usuarioNombre').textContent = localStorage.getItem('usuario');
    document.getElementById('mostrarEstadisticas').style.display = 'block';
    document.getElementById('tablaSemaforos').style.display = 'table';
    document.getElementById("navbar").style.display = 'block';
   document.querySelector('.login-container').classList.add('oculto'); // Añade esta línea
    cargarEstados();
}

    document.addEventListener("DOMContentLoaded", function () {
      var usuario = localStorage.getItem("usuario");
        if (usuario) {
            document.getElementById("usuarioNombre").textContent = usuario;
            document.getElementById("navbar").style.display = "block";
            mostrarApp(); // Llamar a mostrarApp() para cargar la aplicación si hay usuario
        } else {
            document.getElementById("navbar").style.display = "none";
            mostrarFormularioLogin();
        }

});
      
      function toggleMenu() {
    const menu = document.getElementById('dropdown-menu');
    menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
}

  
        function logout() {
          alert("Cerrando sesión...");
            localStorage.removeItem('usuario');
            document.getElementById('login').style.display = 'block';
            document.getElementById('app').style.display = 'none';
	         document.getElementById('mostrarEstadisticas').style.display = 'none'; // Agregar esta línea
           document.getElementById('tablaSemaforos').style.display = 'none'; // Agregar esta línea
           document.getElementById('dropdown-menu').style.display = 'block';
              
          document.getElementById("navbar").style.display = "none"; // Ocultar navbar
          mostrarFormularioLogin(); // Mostrar formulario de login en la misma página
              // Limpiar la tabla
          const tablaBody = document.querySelector('#tablaSemaforos tbody');               
          tablaBody.innerHTML = '';
          
            // Limpiar campos del formulario de inicio de sesión
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('errorMensaje').textContent = ''; // Limpiar mensaje de error
          
           document.querySelector('.login-container').classList.remove('oculto'); // Añade esta línea
        }
      
      // Función para mostrar el formulario de login
function mostrarFormularioLogin() {
    document.getElementById("login").style.display = "block";
}

        function abrirVentanaEmergente() {
            const numeroGrua = prompt("Ingrese el número de la grúa:");
            if (numeroGrua) {
                agregarGrua(numeroGrua);
            } else {
                alert("El número de grúa es obligatorio.");
            }
        }

        function agregarGrua(numeroGrua) {
            const nuevoId = 'grua' + Date.now();
            database.ref(nuevoId).set({
                numero: numeroGrua,
                top: 50,
                left: 50,
                estado: 'green'
            });
        }
		


        function cargarEstados() {
            const contenedor = document.querySelector('.contenedor');
            contenedor.innerHTML = '';

            database.ref('imagenFondo').once('value', snapshot => {
                const urlImagenFondo = snapshot.val();
                if (urlImagenFondo) {
                    const imagenPlano = document.createElement('img');
                    imagenPlano.src = urlImagenFondo;
                    imagenPlano.classList.add('plano');
                    imagenPlano.alt = 'Plano de grúas';
                    contenedor.appendChild(imagenPlano);
                }
            });


            document.getElementById('agregarGrua').onclick = function() {
                abrirVentanaEmergente();
            };

            document.getElementById('eliminarGrua').onclick = function() {
                const gruaSeleccionada = document.querySelector('.grua.seleccionada');
                if (gruaSeleccionada) {
                    database.ref(gruaSeleccionada.id).remove();
                    gruaSeleccionada.remove();
                }
            };

            contenedor.addEventListener('click', (e) => {
                if (e.target.classList.contains('grua')) {
                    const gruas = document.querySelectorAll('.grua');
                    gruas.forEach(grua => grua.classList.remove('seleccionada'));
                    e.target.classList.add('seleccionada');
                }
            });

    database.ref('/').on('child_removed', snapshot => {
        const gruaId = snapshot.key;
        const gruaElemento = document.getElementById(gruaId);
        if (gruaElemento) {
            const numeroGrua = gruaElemento.textContent; // Obtener el número del DOM
            gruaElemento.remove();
            actualizarTablaSemaforos();
            alert(`Grúa ${numeroGrua} eliminada.`);
            gruasEliminadas.push(gruaId); // Agregar gruaId a la lista de eliminados
        }
    });
          
              database.ref('/').on('child_changed', snapshot => {
        const gruaId = snapshot.key;
        if (gruaId.startsWith('grua') && !gruasEliminadas.includes(gruaId)) {
            const gruaElemento = document.getElementById(gruaId);
            if(gruaElemento){
                const { estado, top, left } = snapshot.val();
                if (gruaElemento) {
                    gruaElemento.style.top = top + 'px';
                    gruaElemento.style.left = left + 'px';
                    gruaElemento.style.backgroundColor = estado || 'green';
                    actualizarTablaSemaforos();
                }
            }
        }
    });


            database.ref('/').on('child_changed', snapshot => {
                const gruaId = snapshot.key;
                if (gruaId.startsWith('grua')) {
                    const { estado, top, left } = snapshot.val();
                    const gruaElemento = document.getElementById(gruaId);
                    if (gruaElemento) {
                        gruaElemento.style.top = top + 'px';
                        gruaElemento.style.left = left + 'px';
                        gruaElemento.style.backgroundColor = estado || 'green';
                        actualizarTablaSemaforos(); // Actualizar la tabla después de un cambio
                    }
                }
            });

	        database.ref('/').on('child_added', snapshot => {
                const gruaId = snapshot.key;
                if (gruaId.startsWith('grua')) {
                    const { estado, top, left, numero } = snapshot.val();

                    const gruaElemento = document.createElement('div');
                    gruaElemento.id = gruaId;
                    gruaElemento.classList.add('grua');
                    gruaElemento.style.top = top + 'px';
                    gruaElemento.style.left = left + 'px';
                    gruaElemento.textContent = numero || gruaId.replace('grua', '');
                    gruaElemento.style.backgroundColor = estado || 'green';
                    actualizarTablaSemaforos(); // Actualizar la tabla después de un cambio
                    let offsetX, offsetY, moviendo = false;
                    let toqueCount = 0;



			gruaElemento.addEventListener('mousedown', (e) => {
    e.preventDefault(); // Prevenir la selección de texto

    moviendo = true;
    offsetX = e.clientX - gruaElemento.offsetLeft;
    offsetY = e.clientY - gruaElemento.offsetTop;
    gruaElemento.style.cursor = 'grabbing';
});
                    
                  
                      document.getElementById('eliminarGrua').onclick = function() {
        const gruaSeleccionada = document.querySelector('.grua.seleccionada');
        if (gruaSeleccionada) {
            database.ref(gruaSeleccionada.id).remove().then(() => {
                gruaSeleccionada.remove();
            });
        }
    };
                  
                  
                  document.addEventListener('mousemove', (e) => {
                        if (moviendo) {
                            gruaElemento.style.left = (e.clientX - offsetX) + 'px';
                            gruaElemento.style.top = (e.clientY - offsetY) + 'px';
                            database.ref(gruaId).update({
                                top: parseInt(gruaElemento.style.top),
                                left: parseInt(gruaElemento.style.left)
                            });
                        }
                    });

                    document.addEventListener('mouseup', () => {
                        if (moviendo) {
                            moviendo = false;
                            gruaElemento.style.cursor = 'grab';
                        }
                    });

                    gruaElemento.addEventListener('touchstart', (e) => {
                        toqueCount++;
                        if (toqueCount === 3) {
                            const colores = ['green', 'blue', 'red'];
                            const colorActual = gruaElemento.style.backgroundColor;
                            const nuevoColor = colores[(colores.indexOf(colorActual) + 1) % colores.length];
                            gruaElemento.style.backgroundColor = nuevoColor;
                            database.ref(gruaId).update({ estado: nuevoColor });
                            toqueCount = 0;
                        }

                        moviendo = true;
                        offsetX = e.touches[0].clientX - gruaElemento.offsetLeft;
                        offsetY = e.touches[0].clientY - gruaElemento.offsetTop;
                    });

                    document.addEventListener('touchmove', (e) => {
                        if (moviendo) {
                            const touch = e.touches[0];
                            gruaElemento.style.left = (touch.clientX - offsetX) + 'px';
                            gruaElemento.style.top = (touch.clientY - offsetY) + 'px';
                            database.ref(gruaId).update({
                                top: parseInt(gruaElemento.style.top),
                                left: parseInt(gruaElemento.style.left)
                            });
                        }
                    });

                    document.addEventListener('touchend', () => {
                        if (moviendo) {
                            moviendo = false;
                        }
                    });

                    gruaElemento.addEventListener('dblclick', () => {
                        const colores = ['green', 'blue', 'red'];
                        const nuevoEstado = colores[(colores.indexOf(gruaElemento.style.backgroundColor) + 1) % colores.length];
                        gruaElemento.style.backgroundColor = nuevoEstado;
                        database.ref(gruaId).update({ estado: nuevoEstado });
						
                    });

                    contenedor.appendChild(gruaElemento);
                   actualizarTablaSemaforos(); // Actualizar la tabla después de agregar una grúa
                }
            });
			
			      actualizarTablaSemaforos();
        }
      
      document.addEventListener('click', function(event) {
  const menu = document.getElementById('dropdown-menu');
  const userMenu = document.querySelector('.user-menu');

  if (menu.style.display === 'block' && !userMenu.contains(event.target)) {
    menu.style.display = 'none';
  }
});
		
        function actualizarTablaSemaforos() {
            const tablaBody = document.querySelector('#tablaSemaforos tbody');
            tablaBody.innerHTML = ''; // Limpiar la tabla
            
           //const gruas = document.querySelectorAll('.grua');   //codigo anterior si falla ub icar         
            const gruas = Array.from(document.querySelectorAll('.grua')); // Obtener las grúas como un array

              // Ordenar las grúas por número
              gruas.sort((a, b) => {
              const numeroA = parseInt(a.textContent);
              const numeroB = parseInt(b.textContent);
              return numeroA - numeroB;
              });
          
           
            const estados = { green: 0, red: 0, blue: 0 };
            gruas.forEach(grua => {
                const color = grua.style.backgroundColor;
                const numero = grua.textContent;

                // Contar las grúas por color
                if (color === 'green') estados.green++;
                else if (color === 'red') estados.red++;
                else if (color === 'blue') estados.blue++;

                // Crear una fila para cada grúa
                const fila = document.createElement('tr');
                fila.innerHTML = `
                    <td>${numero}</td>
                    <td>${color === 'red' ? 'X' : ''}</td>
                    <td>${color === 'green' ? 'X' : ''}</td>
                    <td>${color === 'blue' ? 'X' : ''}</td>
                `;
                tablaBody.appendChild(fila);
            });

            // Actualizar los totales en la tabla
            document.getElementById('totalRojo').textContent = estados.red;
            document.getElementById('totalVerde').textContent = estados.green;
            document.getElementById('totalAzul').textContent = estados.blue;
        }


			
    </script>

</body>
</html>
